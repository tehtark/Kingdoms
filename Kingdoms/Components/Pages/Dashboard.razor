@using Kingdoms.Application.Features.Holding.Commands
@using Kingdoms.Application.Features.Holding.Queries
@using Kingdoms.Application.Features.Player.Commands
@using Kingdoms.Application.Features.Player.Queries

@attribute [Authorize]
@inject ISender _mediator
@inject NavigationManager _nav
@inject IDialogService _dialogService

@if (_loaded)
{
    if (_player is not null)
    {
        <PlayerInformation Player="_player" />
    }
    else
    {
        <PlayerInitialisation PlayerId="@_playerId" />
    }
}
else
{
    <Loading />
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationState { get; set; }
    private bool _loaded;

    private Player? _player;
    private string? _playerId;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(Globals.DefaultDelay);

        if (AuthenticationState is not null)
        {
            var state = await AuthenticationState;
            _playerId = await _mediator.Send(new GetPlayerIdFromAuthenticationStateQuery(state));

            if (_playerId is not null)
            {
                _player = await _mediator.Send(new GetPlayerByIdQuery(_playerId));
            }
            _loaded = true;
        }
    }
}